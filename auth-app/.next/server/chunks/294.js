"use strict";exports.id=294,exports.ids=[294],exports.modules={6294:(e,t,a)=>{a.d(t,{t:()=>m});var r=a(2746),n=a(7679),o=a(904),d=a(4209),i=a(8717);let s=({usePlural:e,schema:t,disableIdGeneration:a,options:o,customIdGenerator:i,supportsUUIDs:s})=>{let l=(0,r.i)({usePlural:e,schema:t});return({customModelName:e,forceAllowId:t})=>{let r=o.advanced?.database?.useNumberId||o.advanced?.database?.generateId==="serial",u=o.advanced?.database?.generateId==="uuid",f=!a&&(!r||!!t)&&(!u||!s),p=l(e??"id");return{type:r?"number":"string",required:!!f,...f?{defaultValue(){if(a)return;let e=o.advanced?.database?.generateId;if(!1!==e&&!r)return"function"==typeof e?e({model:p}):i?i({model:p}):"uuid"===e?crypto.randomUUID():(0,n.t)()}}:{},transform:{input:e=>{if(e){if(r){let t=Number(e);if(isNaN(t))return;return t}if(u){if(f&&!t)return e;if(a||s)return;if(t&&"string"==typeof e){if(/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e))return e;{let e=Error().stack?.split("\n").filter((e,t)=>1!==t).join("\n").replace("Error:","");d.kg.warn("[Adapter Factory] - Invalid UUID value for field `id` provided when `forceAllowId` is true. Generating a new UUID.",e)}}return"string"==typeof e||s?void 0:crypto.randomUUID()}return e}},output:e=>{if(e)return String(e)}}}}},l=({usePlural:e,schema:t,options:a,customIdGenerator:n,disableIdGeneration:o})=>{let d=(0,r.i)({usePlural:e,schema:t}),l=(0,r.r)({usePlural:e,schema:t}),u=s({usePlural:e,schema:t,options:a,customIdGenerator:n,disableIdGeneration:o});return({model:e,field:a})=>{let r=d(e),n=l({field:a,model:r}),o=t[r].fields;o.id=u({customModelName:r});let s=o[n];if(!s)throw new i.Q(`Field ${a} not found in model ${e}`);return s}},u=[],f=-1,p=e=>t=>t(e),m=({adapter:e,config:t})=>a=>{let n=Math.random().toString(36).substring(2,15),m={...t,supportsBooleans:t.supportsBooleans??!0,supportsDates:t.supportsDates??!0,supportsJSON:t.supportsJSON??!1,adapterName:t.adapterName??t.adapterId,supportsNumericIds:t.supportsNumericIds??!0,supportsUUIDs:t.supportsUUIDs??!1,transaction:t.transaction??!1,disableTransformInput:t.disableTransformInput??!1,disableTransformOutput:t.disableTransformOutput??!1,disableTransformJoin:t.disableTransformJoin??!1};if((a.advanced?.database?.useNumberId===!0||a.advanced?.database?.generateId==="serial")&&!1===m.supportsNumericIds)throw new i.Q(`[${m.adapterName}] Your database or database adapter does not support numeric ids. Please disable "useNumberId" in your config.`);let b=(0,r.a)(a),h=(...e)=>{if(!0===m.debugLogs||"object"==typeof m.debugLogs){if("object"==typeof m.debugLogs&&"isRunningAdapterTests"in m.debugLogs){m.debugLogs.isRunningAdapterTests&&(e.shift(),u.push({instance:n,args:e}));return}if("object"!=typeof m.debugLogs||!m.debugLogs.logCondition||m.debugLogs.logCondition?.()){if("object"==typeof e[0]&&"method"in e[0]){let t=e.shift().method;if("object"==typeof m.debugLogs){if("create"===t&&!m.debugLogs.create||"update"===t&&!m.debugLogs.update)return;if("updateMany"===t&&!m.debugLogs.updateMany)return;if("findOne"===t&&!m.debugLogs.findOne)return;else if("findMany"===t&&!m.debugLogs.findMany)return;else if("delete"===t&&!m.debugLogs.delete)return;else if("deleteMany"===t&&!m.debugLogs.deleteMany)return;else if("count"===t&&!m.debugLogs.count)return}d.kg.info(`[${m.adapterName}]`,...e)}else d.kg.info(`[${m.adapterName}]`,...e)}}},w=(0,r.i)({usePlural:m.usePlural,schema:b}),I=(0,r.r)({usePlural:m.usePlural,schema:b}),N=(0,r.t)({usePlural:m.usePlural,schema:b}),v=(0,r.n)({schema:b,usePlural:m.usePlural}),M=s({schema:b,options:a,usePlural:m.usePlural,disableIdGeneration:m.disableIdGeneration,customIdGenerator:m.customIdGenerator,supportsUUIDs:m.supportsUUIDs}),O=l({schema:b,options:a,usePlural:m.usePlural,disableIdGeneration:m.disableIdGeneration,customIdGenerator:m.customIdGenerator}),j=async(e,t,r,n)=>{let o={},i=b[t].fields,s=m.mapKeysTransformInput??{},l=a.advanced?.database?.useNumberId||a.advanced?.database?.generateId==="serial";for(let u in i.id=M({customModelName:t,forceAllowId:n&&"id"in e}),i){let n=e[u],f=i[u],p=s[u]||i[u].fieldName||u;if(void 0===n&&(void 0===f.defaultValue&&!f.transform?.input&&!("update"===r&&f.onUpdate)||"update"===r&&!f.onUpdate))continue;if(f&&"date"===f.type&&!(n instanceof Date)&&"string"==typeof n)try{n=new Date(n)}catch{d.kg.error("[Adapter Factory] Failed to convert string to date",{value:n,field:u})}let c=function(e,t,a){return"update"===a?void 0===e&&void 0!==t.onUpdate?"function"==typeof t.onUpdate?t.onUpdate():t.onUpdate:e:"create"===a&&(void 0===e||!0===t.required&&null===e)&&void 0!==t.defaultValue?"function"==typeof t.defaultValue?t.defaultValue():t.defaultValue:e}(n,f,r);f.transform?.input&&(c=await f.transform.input(c)),f.references?.field==="id"&&l?c=Array.isArray(c)?c.map(e=>null!==e?Number(e):null):null!==c?Number(c):null:!1===m.supportsJSON&&"object"==typeof c&&"json"===f.type?c=JSON.stringify(c):!1===m.supportsDates&&c instanceof Date&&"date"===f.type?c=c.toISOString():!1===m.supportsBooleans&&"boolean"==typeof c&&(c=c?1:0),m.customTransformInput&&(c=m.customTransformInput({data:c,action:r,field:p,fieldAttributes:f,model:N(t),schema:b,options:a})),void 0!==c&&(o[p]=c)}return o},D=async(e,t,r=[],n)=>{let d=async(e,t,r=[])=>{if(!e)return null;let n=m.mapKeysTransformOutput??{},d={},i=b[w(t)].fields;for(let s in i[Object.entries(n).find(([e,t])=>"id"===t)?.[0]??"id"]={type:a.advanced?.database?.useNumberId||a.advanced?.database?.generateId==="serial"?"number":"string"},i){if(r.length&&!r.includes(s))continue;let l=i[s];if(l){let i=l.fieldName||s,u=e[Object.entries(n).find(([e,t])=>t===i)?.[0]||i];l.transform?.output&&(u=await l.transform.output(u));let f=n[s]||s;"id"===i||l.references?.field==="id"?null!=u&&(u=String(u)):!1===m.supportsJSON&&"string"==typeof u&&"json"===l.type?u=(0,o.t)(u):!1===m.supportsDates&&"string"==typeof u&&"date"===l.type?u=new Date(u):!1===m.supportsBooleans&&"number"==typeof u&&"boolean"===l.type&&(u=1===u),m.customTransformOutput&&(u=m.customTransformOutput({data:u,field:f,fieldAttributes:l,select:r,model:N(t),schema:b,options:a})),d[f]=u}}return d};if(!n||0===Object.keys(n).length)return await d(e,t,r);t=w(t);let i=await d(e,t,r),s=Object.entries(n).map(([e,t])=>({modelName:N(e),defaultModelName:w(e),joinConfig:t}));if(!e)return null;for(let{modelName:r,defaultModelName:n,joinConfig:o}of s){let s=await (async()=>a.experimental?.joins?e[r]:await U({baseModel:t,baseData:i,joinModel:r,specificJoinConfig:o}))();null==s&&(s="one-to-one"===o.relation?null:[]),"one-to-many"!==o.relation||Array.isArray(s)||(s=[s]);let l=[];if(Array.isArray(s))for(let e of s){let t=await d(e,r,[]);l.push(t)}else{let e=await d(s,r,[]);l.push(e)}i[n]=("one-to-one"===o.relation?l[0]:l)??null}return i},L=({model:e,where:t})=>{if(!t)return;let r=m.mapKeysTransformInput??{};return t.map(t=>{let{field:n,value:o,operator:d="eq",connector:s="AND"}=t;if("in"===d&&!Array.isArray(o))throw new i.Q("Value must be an array");let l=o,u=w(e),f=I({field:n,model:e}),p=r[f]||v({field:f,model:u}),c=O({field:f,model:u}),y=a.advanced?.database?.useNumberId||a.advanced?.database?.generateId==="serial";if(("id"===f||c.references?.field==="id")&&y&&(l=Array.isArray(o)?o.map(Number):Number(o)),"date"===c.type&&o instanceof Date&&!m.supportsDates&&(l=o.toISOString()),"boolean"!==c.type||"boolean"!=typeof o||m.supportsBooleans||(l=o?1:0),"json"===c.type&&"object"==typeof o&&!m.supportsJSON)try{l=JSON.stringify(o)}catch(e){throw Error(`Failed to stringify JSON value for field ${p}`,{cause:e})}return{operator:d,connector:s,field:p,value:l}})},T=(e,t,r)=>{if(!t||0===Object.keys(t).length)return;let n={};for(let[o,d]of Object.entries(t)){let t,s,l;if(!d)continue;let u=w(o),f=w(e),p=Object.entries(b[u].fields).filter(([e,t])=>t.references&&w(t.references.model)===f),m=!0;if(p.length||(p=Object.entries(b[f].fields).filter(([e,t])=>t.references&&w(t.references.model)===u),m=!1),p.length){if(p.length>1)throw new i.Q(`Multiple foreign keys found for model ${o} and base model ${e} while performing join operation. Only one foreign key is supported.`)}else throw new i.Q(`No foreign key found for model ${o} and base model ${e} while performing join operation.`);let[c,y]=p[0];if(!y.references)throw new i.Q(`No references found for foreign key ${c} on model ${o} while performing join operation.`);m?(t=v({model:e,field:l=y.references.field}),s=v({model:o,field:c})):(t=v({model:e,field:l=c}),s=v({model:o,field:y.references.field})),r&&!r.includes(l)&&r.push(l);let $="id"===s||(y.unique??!1),g=a.advanced?.database?.defaultFindManyLimit??100;$?g=1:"object"==typeof d&&"number"==typeof d.limit&&(g=d.limit),n[N(o)]={on:{from:t,to:s},limit:g,relation:$?"one-to-one":"one-to-many"}}return{join:n,select:r}},U=async({baseModel:e,baseData:t,joinModel:r,specificJoinConfig:n})=>{let o;if(!t)return t;let i=N(r),s=n.on.to,l=t[I({field:n.on.from,model:e})];if(null==l)return"one-to-one"===n.relation?null:[];let u=L({model:i,where:[{field:s,value:l,operator:"eq",connector:"AND"}]});try{if("one-to-one"===n.relation)o=await P.findOne({model:i,where:u});else{let e=n.limit??a.advanced?.database?.defaultFindManyLimit??100;o=await P.findMany({model:i,where:u,limit:e})}}catch(e){throw d.kg.error(`Failed to query fallback join for model ${i}:`,{where:u,limit:n.limit}),console.error(e),e}return o},P=e({options:a,schema:b,debugLog:h,getFieldName:v,getModelName:N,getDefaultModelName:w,getDefaultFieldName:I,getFieldAttributes:O,transformInput:j,transformOutput:D,transformWhereClause:L}),k=null,A={transaction:async e=>(k||(m.transaction?(d.kg.debug(`[${m.adapterName}] - Using provided transaction implementation.`),k=m.transaction):k=p(A)),k(e)),create:async({data:e,model:t,select:a,forceAllowId:r=!1})=>{let n=++f,o=N(t);t=w(t),"id"in e&&void 0!==e.id&&!r&&(d.kg.warn(`[${m.adapterName}] - You are trying to create a record with an id. This is not allowed as we handle id generation for you, unless you pass in the \`forceAllowId\` parameter. The id will be ignored.`),console.log(Error().stack?.split("\n").filter((e,t)=>1!==t).join("\n").replace("Error:","Create method with `id` being called at:")),e.id=void 0),h({method:"create"},`${c(n)} ${y(1,4)}`,`${$("create")} ${g("Unsafe Input")}:`,{model:o,data:e});let i=e;m.disableTransformInput||(i=await j(e,t,"create",r)),h({method:"create"},`${c(n)} ${y(2,4)}`,`${$("create")} ${g("Parsed Input")}:`,{model:o,data:i});let s=await P.create({data:i,model:o});h({method:"create"},`${c(n)} ${y(3,4)}`,`${$("create")} ${g("DB Result")}:`,{model:o,res:s});let l=s;return m.disableTransformOutput||(l=await D(s,t,a,void 0)),h({method:"create"},`${c(n)} ${y(4,4)}`,`${$("create")} ${g("Parsed Result")}:`,{model:o,data:l}),l},update:async({model:e,where:t,update:a})=>{let r=++f,n=N(e=w(e)),o=L({model:e,where:t});h({method:"update"},`${c(r)} ${y(1,4)}`,`${$("update")} ${g("Unsafe Input")}:`,{model:n,data:a});let d=a;m.disableTransformInput||(d=await j(a,e,"update")),h({method:"update"},`${c(r)} ${y(2,4)}`,`${$("update")} ${g("Parsed Input")}:`,{model:n,data:d});let i=await P.update({model:n,where:o,update:d});h({method:"update"},`${c(r)} ${y(3,4)}`,`${$("update")} ${g("DB Result")}:`,{model:n,data:i});let s=i;return m.disableTransformOutput||(s=await D(i,e,void 0,void 0)),h({method:"update"},`${c(r)} ${y(4,4)}`,`${$("update")} ${g("Parsed Result")}:`,{model:n,data:s}),s},updateMany:async({model:e,where:t,update:a})=>{let r=++f,n=N(e),o=L({model:e,where:t});e=w(e),h({method:"updateMany"},`${c(r)} ${y(1,4)}`,`${$("updateMany")} ${g("Unsafe Input")}:`,{model:n,data:a});let d=a;m.disableTransformInput||(d=await j(a,e,"update")),h({method:"updateMany"},`${c(r)} ${y(2,4)}`,`${$("updateMany")} ${g("Parsed Input")}:`,{model:n,data:d});let i=await P.updateMany({model:n,where:o,update:d});return h({method:"updateMany"},`${c(r)} ${y(3,4)}`,`${$("updateMany")} ${g("DB Result")}:`,{model:n,data:i}),h({method:"updateMany"},`${c(r)} ${y(4,4)}`,`${$("updateMany")} ${g("Parsed Result")}:`,{model:n,data:i}),i},findOne:async({model:e,where:t,select:r,join:n})=>{let o;let d=++f,i=N(e),s=L({model:e,where:t});e=w(e);let l=!0;if(m.disableTransformJoin)o=n;else{let t=T(e,n,r);t&&(o=t.join,r=t.select),!a.experimental?.joins&&o&&Object.keys(o).length>0&&(l=!1)}h({method:"findOne"},`${c(d)} ${y(1,3)}`,`${$("findOne")}:`,{model:i,where:s,select:r,join:o});let u=await P.findOne({model:i,where:s,select:r,join:l?o:void 0});h({method:"findOne"},`${c(d)} ${y(2,3)}`,`${$("findOne")} ${g("DB Result")}:`,{model:i,data:u});let p=u;return m.disableTransformOutput||(p=await D(u,e,r,o)),h({method:"findOne"},`${c(d)} ${y(3,3)}`,`${$("findOne")} ${g("Parsed Result")}:`,{model:i,data:p}),p},findMany:async({model:e,where:t,limit:r,sortBy:n,offset:o,join:d})=>{let i;let s=++f,l=r??a.advanced?.database?.defaultFindManyLimit??100,u=N(e),p=L({model:e,where:t});e=w(e);let b=!0;if(m.disableTransformJoin)i=d;else{let t=T(e,d,void 0);t&&(i=t.join),!a.experimental?.joins&&i&&Object.keys(i).length>0&&(b=!1)}h({method:"findMany"},`${c(s)} ${y(1,3)}`,`${$("findMany")}:`,{model:u,where:p,limit:l,sortBy:n,offset:o,join:i});let I=await P.findMany({model:u,where:p,limit:l,sortBy:n,offset:o,join:b?i:void 0});h({method:"findMany"},`${c(s)} ${y(2,3)}`,`${$("findMany")} ${g("DB Result")}:`,{model:u,data:I});let v=I;return m.disableTransformOutput||(v=await Promise.all(I.map(async t=>await D(t,e,void 0,i)))),h({method:"findMany"},`${c(s)} ${y(3,3)}`,`${$("findMany")} ${g("Parsed Result")}:`,{model:u,data:v}),v},delete:async({model:e,where:t})=>{let a=++f,r=N(e),n=L({model:e,where:t});e=w(e),h({method:"delete"},`${c(a)} ${y(1,2)}`,`${$("delete")}:`,{model:r,where:n}),await P.delete({model:r,where:n}),h({method:"delete"},`${c(a)} ${y(2,2)}`,`${$("delete")} ${g("DB Result")}:`,{model:r})},deleteMany:async({model:e,where:t})=>{let a=++f,r=N(e),n=L({model:e,where:t});e=w(e),h({method:"deleteMany"},`${c(a)} ${y(1,2)}`,`${$("deleteMany")} ${g("DeleteMany")}:`,{model:r,where:n});let o=await P.deleteMany({model:r,where:n});return h({method:"deleteMany"},`${c(a)} ${y(2,2)}`,`${$("deleteMany")} ${g("DB Result")}:`,{model:r,data:o}),o},count:async({model:e,where:t})=>{let a=++f,r=N(e),n=L({model:e,where:t});e=w(e),h({method:"count"},`${c(a)} ${y(1,2)}`,`${$("count")}:`,{model:r,where:n});let o=await P.count({model:r,where:n});return h({method:"count"},`${c(a)} ${y(2,2)}`,`${$("count")}:`,{model:r,data:o}),o},createSchema:P.createSchema?async(e,t)=>{let n=(0,r.a)(a);return a.secondaryStorage&&!a.session?.storeSessionInDatabase&&delete n.session,a.rateLimit&&"database"===a.rateLimit.storage&&(void 0===a.rateLimit.enabled||!0===a.rateLimit.enabled)&&(n.ratelimit={modelName:a.rateLimit.modelName??"ratelimit",fields:{key:{type:"string",unique:!0,required:!0,fieldName:a.rateLimit.fields?.key??"key"},count:{type:"number",required:!0,fieldName:a.rateLimit.fields?.count??"count"},lastRequest:{type:"number",required:!0,bigint:!0,defaultValue:()=>Date.now(),fieldName:a.rateLimit.fields?.lastRequest??"lastRequest"}}}),P.createSchema({file:t,tables:n})}:void 0,options:{adapterConfig:m,...P.options??{}},id:m.adapterId,...m.debugLogs?.isRunningAdapterTests?{adapterTestDebugLogs:{resetDebugLogs(){u=u.filter(e=>e.instance!==n)},printDebugLogs(){let e=`â”€`.repeat(80),t=u.filter(e=>e.instance===n);0!==t.length&&console.log(...t.reverse().map(e=>(e.args[0]=`
${e.args[0]}`,[...e.args,"\n"])).reduce((e,t)=>[...t,...e],[`
${e}`]))}}}:{}};return A};function c(e){return 8>(0,d.Pd)()?`#${e}`:`${d.E6.fg.magenta}#${e}${d.E6.reset}`}function y(e,t){return`${d.E6.bg.black}${d.E6.fg.yellow}[${e}/${t}]${d.E6.reset}`}function $(e){return`${d.E6.bright}${e}${d.E6.reset}`}function g(e){return`${d.E6.dim}(${e})${d.E6.reset}`}}};